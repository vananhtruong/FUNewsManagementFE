@page
@model FUNewsManagementSystem.Pages.Categories.IndexModel

@{
    ViewData["Title"] = "Category Management";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div id="errorMessage" class="alert alert-danger d-none"></div>
        <h1 class="fw-bold text-primary mb-4">@ViewData["Title"]</h1>

        <div class="mb-3">
            <a href="/Categories/Create" class="btn btn-success shadow-sm">➕ Create New Category</a>
        </div>

        <div class="table-responsive shadow-sm rounded bg-white px-3 py-3">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#️⃣ No.</th>
                        <th>📛 Name</th>
                        <th style="width: 30%;">📝 Description</th>
                        <th>✅ Active</th>
                        <th class="text-center">⚡ Action</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Data will be injected here by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteCategoryLabel">🗑️ Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="deleteCategoryContent">
                    <p>⚠️ Are you sure you want to delete <strong id="deleteCategoryName"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌ Cancel</button>
                    <button type="button" id="confirmDeleteCategoryBtn" class="btn btn-danger">🗑️ Confirm Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem("jwtToken");
        const apiUrl = "https://localhost:7126/api/Category";

        function loadCategories() {
            fetch(apiUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('categoryTableBody');
                    tbody.innerHTML = '';
                    data.forEach((cat, i) => {
                        const row = `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${cat.categoryName}</td>
                                <td><div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">${cat.categoryDesciption || ''}</div></td>
                                <td><span class="badge bg-${cat.isActive ? 'success' : 'danger'}">${cat.isActive ? 'Active' : 'Inactive'}</span></td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="/Categories/Details?id=${cat.categoryId}" class="btn btn-sm btn-outline-primary">👁️ Details</a>
                                        <a href="/Categories/Edit?id=${cat.categoryId}" class="btn btn-sm btn-warning">✏️ Edit</a>
                                        <button class="btn btn-sm btn-danger delete-category-btn" data-id="${cat.categoryId}" data-name="${cat.categoryName}">🗑️ Delete</button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    document.getElementById('errorMessage').classList.remove('d-none');
                    document.getElementById('errorMessage').textContent = '❌ Failed to load categories.';
                });
        }

        loadCategories();

        let deleteCategoryId;
        document.addEventListener('click', function (e) {
            if (e.target && e.target.classList.contains('delete-category-btn')) {
                deleteCategoryId = e.target.getAttribute('data-id');
                const categoryName = e.target.getAttribute('data-name');
                document.getElementById('deleteCategoryName').textContent = categoryName;
                new bootstrap.Modal(document.getElementById('deleteCategoryModal')).show();
            }
        });

        document.getElementById('confirmDeleteCategoryBtn').addEventListener('click', function () {
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal'));
            fetch(`${apiUrl}/${deleteCategoryId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(res => {
                    if (res.ok) {
                        deleteModal.hide();
                        loadCategories();
                    } else {
                        alert('❌ Delete failed.');
                    }
                })
                .catch(error => alert('❌ Error: ' + error));
        });
    </script>
</body>
</html>
